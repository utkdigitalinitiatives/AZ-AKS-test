apiVersion: solr.apache.org/v1beta1
kind: SolrCloud
metadata:
  name: solr-search
  namespace: solr-search
spec:
  # Solr version and replicas
  solrImage:
    tag: "9.8.1"  # Latest stable version
  replicas: 2  # Start with 2 replicas for efficiency
  
  # Java memory configuration - conservative for 16GB node
  solrJavaMem: "-Xms512m -Xmx1g"
  
  # Storage configuration
  storageOptions:
    filesystemPath: "/var/solr/data"
    persistentStorage:
      storageClassName: default
      reclaimPolicy: Delete
      accessModes:
        - ReadWriteOnce
      resources:
        requests:
          storage: "10Gi"
  
  # Resource limits
  resources:
    requests:
      memory: "1.5Gi"
      cpu: "300m"
    limits:
      memory: "2Gi"
      cpu: "500m"
  
  # Zookeeper reference
  zookeeperRef:
    provided:
      zookeeperCluster:
        name: "solr-zookeeper"
        namespace: "solr-search"
  
  # Update strategy
  updateStrategy:
    method: "Managed"  # Recommended for production
    managed:
      maxPodsUnavailable: 1
  
  # Solr configuration
  solrOpts: "-Dsolr.autoSoftCommit.maxTime=10000"
  
  # Pod configuration
  podOptions:
    affinity:
      podAntiAffinity:
        preferredDuringSchedulingIgnoredDuringExecution:
        - weight: 100
          podAffinityTerm:
            labelSelector:
              matchLabels:
                solr-cloud: solr-search
            topologyKey: kubernetes.io/hostname
    
    # Environment variables
    env:
    - name: SOLR_LOG_LEVEL
      value: "INFO"
    - name: GC_TUNE
      value: "-XX:+UseG1GC -XX:+UseStringDeduplication"
  
  # Service configuration for external access
  solrAddressability:
    external:
      method: LoadBalancer
      domainName: "solr.local"
      hideCommon: false
    commonServicePort: 8983
    kubeDomain: "cluster.local"
